---
title: "Darwin Core Mapping"
subtitle: "MICA - Muskrat occurrences collected by RATO in East Flanders, Belgium"
author: "Dimitri Brosens"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    number_sections: yes
    toc: yes
    toc_depth: 3
    toc_float: yes
---

# Setup 

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = TRUE)
```

Load libraries:

```{r message = FALSE}
library(tidyverse)      # To do data science
library(tidylog)        # To provide feedback on dplyr functions
library(magrittr)       # To use %<>% pipes
library(here)           # To find files
library(janitor)        # To clean input data
library(readxl)         # To read Excel files
library(digest)         # To generate hashes
library(rgbif)          # To use GBIF services
library(sp)             # coordinate transformation
library(leaflet)        # coordinate transformation
library(widgetframe)    # coordinate transformation
library(sf)             # coordinate transformation
library(lubridate)      # for the date
```

# Read source data

Create a data frame `input_data` from the source data:
The source data was corrected in Excel
Muskrat occurrences opened in openRefine
Obsolete columns removed
some columns renamed to DwC term
File exported to csv

```{r}

input_interim <- read_excel(here::here("datasets", "mica-vmm-occurrences", "data", "raw","VangstenT14_47_33.xlsx"))

```

Preview data:

```{r}
input_interim %>% head(n = 5)
```

# Process source data

## Tidy data

Clean data somewhat:

```{r}
input_interim %<>% 
    remove_empty("rows") %<>%
    clean_names()
```

```{r}
input_interim %>% head(n = 5)
```

# Retrieve scientific names based on the vernacular name

the raw data did not contain scintific names. We use the gbif taxonomic backbone  to retrieve scientififc names based on vernacular names. Manual actions are still needed as the returned information might not be 100% correct

1. we create a specieslist

```{r}
speciesList <- input_interim %>%
  distinct(sporen_waarnemingen_naam)  %>%
  pull() %>% # Create vector from dataframe
  #parsenames()
head(speciesList, n = 30)
```

# filter for needed occurrences

1. introduce dwc_vernacularName
2. remove all data which is not specific enough 
3. replace interpretable data with correct (manually found) scientificName

```{r}
input_interim %<>%
        mutate(dwc_vernacularName = sporen_waarnemingen_naam) %<>%
        filter(dwc_vernacularName != 'Vis' ) %<>%
        filter(dwc_vernacularName != 'Andere') %<>%
        filter(dwc_vernacularName != 'Eend' )%<>%
        filter(dwc_vernacularName != 'Marterachtige' )%<>%
        
        mutate(dwc_vernacularName = recode(dwc_vernacularName
                   , "Muskusr. > 400gr"  = "Muskusrat"
                   , "Doodaars" = "Tachybaptus ruficollis"
                   
                                                  ))
        
head (input_interim, n = 5 )
```





```{r eval=FALSE, include=FALSE}
input_interim %<>% mutate(dwc_vernacularName = sporen_waarnemingen_naam)

input_interim %<>% mutate(dwc_vernacularName = recode(dwc_vernacularName
                   , "Muskusr. > 400gr"  = "Muskusrat"
                   , "Doodaars" = "Tachybaptus ruficollis"
                   
                                                  ))



input_interim %>% head(n = 5)
```

# Make speciesList2

1. check if specieslist is interpretable for GBIF

```{r}
speciesList2 <- input_interim %>%
  distinct(`dwc_vernacularName`)  
  
head(speciesList2, n = 30)
```


# find scientificNames

1. use GBIF function to find scientificNames based on vernacular names

```{r}
vernacular_names_df <- input_interim

get_vernacular_name <- function(vn) {
 names <-
   name_lookup(vn,
               datasetKey = "d7dddbf4-2cf0-4f39-9b2a-bb099caae36c",
               limit = 1)$data # this returns the most likely taxon
 if (nrow(names) > 0) {
   names$scientificName
 } else {
   NA_character_
 }
}

n_vernacular_names_df <-
 vernacular_names_df %>%
 group_by(dwc_vernacularName) %>%
 nest() %>%
 mutate(dwc_scientificName = map_chr(dwc_vernacularName,get_vernacular_name)) %>%
 ungroup() %>%
 select(-one_of("data")) %>%
 right_join(vernacular_names_df, by = "dwc_vernacularName")

#view(n_vernacular_names_df)
```
# make speciesList

```{r}
speciesList3 <- n_vernacular_names_df %>%
  distinct(`dwc_scientificName`)  

input_interim <- n_vernacular_names_df    
head(speciesList3, n = 30)

```

### scientificName 

fix scientificNames

```{r}

input_interim %<>% mutate(scientificName = recode(dwc_scientificName
           , "Zapornia pusilla intermedia (Hermann, 1804)" = "Gallinula chloropus (Linnaeus, 1758)"
                                                            ))

```


# Occurrence core

look at interim_file once more

```{r}
head(input_interim, n = 15)
```


## Pre-processing

Create a dataframe occurrence data only 

```{r}
occurrence <- input_interim
```

## remove obsolete columns

```{r}
occurrence %<>% select(-c(locatie_type_naam, maand_in_jaar, maand_lange_omschrijving, provincie_nis_code))
```


# Term mapping

Map the data to [Darwin Core Occurrence](http://rs.gbif.org/core/dwc_occurrence_2015-07-02.xml).

Start with record-level terms which contain metadata about the dataset (which is generally the same for all records).

# Event

### datasetID

```{r}
occurrence %<>% mutate(datasetID = "insert doi")
```

### type

```{r}
occurrence %<>% mutate(type = "Event")
```

### language

```{r}
occurrence %<>% mutate(language = "en") # e.g. "en"
```

### license

```{r}
occurrence %<>% mutate(license = "http://creativecommons.org/publicdomain/zero/1.0/") 
# e.g. "http://creativecommons.org/publicdomain/zero/1.0/"
```

### rightsHolder

```{r}
occurrence %<>% mutate(rightsHolder = "VMM") # e.g. "INBO"
```
### accessRights

```{r}
occurrence %<>% mutate(accessRights = "http://www.inbo.be/en/norms-for-data-use") 
```

### datasetID

```{r}
#occurrence %<>% mutate(datasetID = "insert doi") 
```

### institutionCode

```{r}
occurrence %<>% mutate(institutionCode = "VMM") # e.g. "INBO"
```

### datasetName

```{r}
occurrence %<>% mutate(datasetName = "MICA - Muskrat occurrences collected by VMM in Flanders, Belgium") # e.g. "Checklist of non-native freshwater fishes in Flanders, Belgium"
```

The following terms contain information about the taxon:

### basisOfRecord

```{r}
occurrence %<>% mutate(basisOfRecord = "HumanObservation")
```

### informationWithHeld

### dataGeneralizations

### occurrenceID

```{r}
occurrence %<>% rename(occurrenceID = registratie_id) %>%
                mutate(occurrenceID = str_c("MICA:VMM:", occurrenceID))
  
```

### recordedBy

```{r}
occurrence %<>% mutate(recordedBy = str_c("VMM team ", team_naam))

head(occurrence)
```

### individualCount

```{r}
occurrence %<>% rename(individualCount = vangst_aantal) 
```

### organismQuantity

### organismQuentityType

### sex

### lifeStage

### behavior

### occurrenceRemarks

```{r eval=FALSE, include=FALSE}
occurrence %<>% rename(occurrenceRemarks = 'action_en')
```

## samplingProtocol

```{r eval=FALSE, include=FALSE}
occurrence %<>% mutate(samplingEffort = materials_en)
```

```{r}
occurrence %<>% mutate(samplingProtocol = 'rat trap') 
```

### samplingEffort

```{r eval=FALSE, include=FALSE}
head(occurrence, n = 5)

occurrence %<>%
  # extract follow ups to new column
  mutate(samplingEffort = str_replace(samplingEffort, "Follow-up=*", "Times-visited=")) %>%
  mutate(samplingEffort = str_replace_all(samplingEffort, "=",":")) %>%
  mutate(samplingEffort = str_replace_all(samplingEffort, ","," |"))
```

### eventDate



```{r}


#occurrence %<>% ymd(date)

occurrence %<>% mutate(eventDate = (Maand))
# mutate(eventDate = as_date(ymd(date))) # , format = "%Y-%m-%d")) 

head(occurrence, n = 5)
```

# Location

```{r}
occurrence %<>%
  rename(decimalLongitude = locatie_gps_lengte) %>%
  rename(decimalLatitude = locatie_gps_breedte) %>%
  
  mutate(coordinateUncertaintyInMeters = "30") %>%
  mutate(countryCode = "BE")  %>%            
  mutate(continent = "Europe") %>%
  mutate(locationID = locatie_id) %>%
  mutate(locationRemarks = vha_categorie_omschrijving)


  

```

```{r}
head(occurrence, n = 5)
occurrence %<>%
  mutate(decimalLongitude = round(decimalLongitude, digits = 5)) %>%
  mutate(decimalLatitude = round(decimalLatitude, digits = 5))
```

```{r}
occurrence %<>%   
   mutate(decimalLatitude = as.character(format(decimalLatitude, nsmall = 5))) %>%
   mutate(decimalLongitude = as.character(format(decimalLongitude, nsmall = 5)))
```

### continent

```{r}
##occurrence %<>% mutate(continent = "Europe") # e.g. "Belgium = BE"
```

### countryCode

```{r}
#occurrence %<>% mutate(countryCode = "BE") # e.g. "Belgium = BE"
```


### StateProvince

```{r}
occurrence %<>% mutate(stateProvince = provincie_omschrijving) # e.g. "Belgium = BE"
```


### municipality

municipality already in source file

```{r}
occurrence %<>%
  mutate(municipality = gemeente_naam)
```

### verbatimcoordinates

### verbatimLatitude

### verbatimLongitude

### verbatimcoordinatesystem

```{r}
#occurrence %<>% mutate(verbatimcoordinatesystem = "Lambert coordinates") # 
```

### verbatimSRS

```{r}
#occurrence %<>% mutate(verbatimSRS = "Belgian Datum 1972")
```

### decimalLatitude

### decimalLongitude

### geodeticDatum

```{r}
occurrence %<>%
  mutate(geodeticDatum = "WGS84") 
```


### locationRemarks

```{r}
occurrence %<>% mutate(locationRemarks = recode(locationRemarks
                   , "CAT2 - Onbevaarbaar cat. 2"  = "CAT2 - not navigable cat. 2"
                   , "CAT1 - Onbevaarbaar cat. 1" = "CAT1 - not navigable cat. 1"
                   , "CAT3 - Onbevaarbaar cat. 3" = "CAT3 - not navigable cat. 3"
                   , "CAT - Andere" = "CAT - other"
                   , "ONB - Onbekend" = "ONB - unknown"
                   , "BEV - Bevaarbaar" = "BEV - navigable"
                                                  ))
```


### coordinateUncertaintyInMeters

### georeferenceRemarks

### identifiedBy

```{r}
occurrence %<>% mutate(identifiedBy = 'VMM')
```



### kingdom

```{r}
occurrence %<>% mutate(kingdom = "Animalia")
```

### scientificNameAuthorship

```{r}
# occurrence %<>% mutate(scientificNameAuthorship = "Linnaeus, 1766")
```

### vernacularName

```{r}
occurrence %<>% mutate(vernacularName = recode(vernacularName
                       , "Tachybaptus ruficollis" = "Doodaars"
                                                            ))
```




### taxonRank

```{r}
occurrence %<>% mutate(taxonRank = "species")
```

### nomenclaturalCode

```{r}
occurrence %<>% mutate(nomenclaturalCode = "ICZN") # e.g. "ICZN"
```

### occurrenceStatus

```{r}
occurrence %<>% 
    ##select(individualCount) %>%
    mutate(occurrenceStatus = case_when(individualCount > 0 ~ "present",
                              individualCount == 0 ~ "absent"
                                 )
                                )
head(occurrence, n = 5)
```

## Post-processing

```{r}
colnames(occurrence) <- str_remove(colnames(occurrence), "dwc_")
occurrence %<>% select(-c(jaar, maand, land_regio, gemeente_naam, locatie_id, team_rol, team_naam,sporen_waarnemingen_naam, vha_categorie_code, vha_categorie_omschrijving, provincie_omschrijving))  #remove collection columns
          ##  rename(scientificName = verbatimScientificName) 



```

```{r}
occurrence <- mutate_all(occurrence, as.character())
```

Define the order of the output columns

```{r}
col_order <- c( "type","language","license","rightsHolder","accessRights","datasetID"
               ,"institutionCode","datasetName","basisOfRecord","occurrenceID","recordedBy"
               ,"individualCount","occurrenceStatus","samplingProtocol"
               ,"eventDate","locationID","continent","countryCode", "stateProvince","municipality","geodeticDatum", "locationRemarks"
               ,"decimalLatitude","decimalLongitude","geodeticDatum","coordinateUncertaintyInMeters"
               ,"identifiedBy","scientificName" ,"kingdom" ,"taxonRank","vernacularName", "nomenclaturalCode"
               )
occurrence <- occurrence[, col_order]
```

Preview data:

```{r}
occurrence %>% head()
```

Save to CSV:

```{r}
write_csv(occurrence, here::here("datasets", "mica-vmm-occurrences", "data", "processed", " occurrence.csv"), na = "")
```

```{r}

```

